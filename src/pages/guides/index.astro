---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const guidesAll = await getCollection("guides", ({ data }) => !data.draft);
const guides = guidesAll.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const allTags = Array.from(new Set(guides.flatMap((g) => g.data.tags || []))).sort((a, b) =>
  a.localeCompare(b)
);

const formatDate = (d: Date) =>
  d.toLocaleDateString("en-GB", { year: "numeric", month: "short", day: "2-digit" });
---

<BaseLayout
  title="Guides · SmallGrid"
  description="Practical tutorials for quiet, low-power homelabs: Jellyfin, mini PCs, simple networking, and backups."
  canonicalPath="/guides/"
>
  <header class="article-header">
    <p class="article-kicker">Guides · SmallGrid</p>
    <h1 class="article-title">Guides</h1>
    <p class="article-lede">
      Practical and opinionated setups for small, efficient homelabs. No port-forwarding heroics. No rack cosplay.
    </p>

    {allTags.length > 0 && (
      <div class="article-meta" style="margin-top: 0.6rem;">
        <span class="article-meta-item">Popular tags</span>
        <ul class="article-tags">
          {allTags.map((tag) => (
            <li class="tag-pill">#{tag}</li>
          ))}
        </ul>
      </div>
    )}
  </header>

  <hr class="article-divider" />

  <section class="guide-grid" aria-label="All guides">
    {guides.map((post) => (
      <article class="guide-card">
        <h2 class="guide-card-title">
          <a class="guide-card-link" href={`/guides/${post.slug}/`}>
            {post.data.title}
          </a>
        </h2>

        <div class="guide-card-meta">
          <span>{formatDate(post.data.pubDate)}</span>
          {post.data.updatedDate ? <span>· Updated {formatDate(post.data.updatedDate)}</span> : null}
        </div>

        <p class="guide-card-desc">{post.data.description}</p>

        {(post.data.tags || []).length ? (
          <ul class="guide-card-tags">
            {(post.data.tags || []).slice(0, 6).map((t) => (
              <li class="tag-pill">#{t}</li>
            ))}
          </ul>
        ) : null}
      </article>
    ))}
  </section>
</BaseLayout>
