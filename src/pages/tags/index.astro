---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

const guides = await getCollection("guides", ({ data }) => !data.draft);

// Build a tag ‚Üí posts map
const tagMap = new Map<string, typeof guides>();

for (const post of guides) {
  const tags = post.data.tags || [];
  for (const tag of tags) {
    const existing = tagMap.get(tag) ?? [];
    existing.push(post);
    tagMap.set(tag, existing);
  }
}

const sortedTags = Array.from(tagMap.keys()).sort((a, b) =>
  a.localeCompare(b, "en", { sensitivity: "base" })
);
---

<BaseLayout
  title="Tags"
  description="Browse SmallGrid guides by topic: backups, Jellyfin, Proxmox, storage, and more."
  canonicalPath="/tags/"
>
  <section class="card">
    <div class="kicker">üè∑Ô∏è Browse by topic</div>
    <h1>Tags</h1>
    <p>
      Explore guides by theme: backups, Jellyfin, Proxmox, storage, and all the other
      pieces that make up a small, efficient homelab.
    </p>
  </section>

  <section style="margin-top: 16px;">
    {sortedTags.length === 0 && (
      <p class="card">
        No tags yet. Once you add tags to your guides, they‚Äôll show up here.
      </p>
    )}

    {sortedTags.length > 0 && (
      <div class="grid">
        {sortedTags.map((tag) => {
          const posts = tagMap.get(tag) ?? [];
          return (
            <article class="card" id={tag}>
              <h2 style="margin-top: 0;">
                #{tag} <span style="font-size: 13px; opacity:.7;">({posts.length})</span>
              </h2>
              <ul style="margin: 0; padding-left: 18px;">
                {posts
                  .sort(
                    (a, b) =>
                      b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
                  )
                  .map((post) => (
                    <li style="margin: 6px 0;">
                      <a href={`/guides/${post.slug}/`}>{post.data.title}</a>
                      <span style="font-size: 12px; opacity:.7;">
                        {" "}
                        ¬∑{" "}
                        {post.data.pubDate.toLocaleDateString("en-GB", {
                          year: "numeric",
                          month: "short",
                          day: "2-digit",
                        })}
                      </span>
                    </li>
                  ))}
              </ul>
            </article>
          );
        })}
      </div>
    )}
  </section>
</BaseLayout>
